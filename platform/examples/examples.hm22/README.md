# oktoflow platform examples: HM'22/TddT'22

Source code for the "Hannover Messe 2022" (HM'22) demonstrator and the extended version to be shown at the exhibition of the "Tage der digitalen Technologien", Berlin (TddT'22).

## Project Structure

This example consists of the
- Code of the services 
  - Java: `src/main/java/de/iip_ecosphere/platform/examples/hm22`
  - Python: `src/main/python/services`
  - Robot movement via ROS: `src/main/python/robot`
- Extensions of the productive services for mocking (for automated integration must not be in testing code)
  - Java: `src/main/java/de/iip_ecosphere/platform/examples/hm22/mock`
  - Python: `src/main/python/servicesMock`
- Example-specific assembly descriptors in `src/main/assembly`
- Custom docker container setup in `src/main/docker`
- IVML configuration `src/main/easy` (including the currently separated platform setup)
- Java Testing `src/test/java`
- Documentation and deployment plans: `docs`. There, you can find a picture of the physical setup, a wiring diagram as well as a service interconnection diagram in [Overview.pdf](docs/Overview.pptx).

A video of a run-though can be found at [youtube](https://youtu.be/36Xtw1L2XkQ).

## Building

Running the applications on **Windows** may fail as Tensorflow lite may fail if there is no adequate version of Tensorflow lite for Windows. For all Maven executions, please use **Java 11 or 13, Maven 3.6.3 or 3.8.5, Python 3.9. Maven commands may run into trouble under Windows Powershell. Generation does not run, e.g., on JDK 17. Please ensure that all Python prerequisites (see ``AllServices.ivml``) are installed, otherwise tests may fail.

`mvn install` or for updates `mvn -U install -Dunpack.force=true` shall build and instantiate the full application. Individual steps if needed are:
- `mvn -P EasyGen generate-sources` downloads and unpacks the actual sources of the configuration model/the instantiation process. Use `-P` to obtain the most recent snapshot. If already build, a short build as described below shall be sufficient.
- `mvn -P EasyGen exec:java@generateAppsNoDeps` validates the model, generates the application-specific service interfaces (Java, Python), the transport mechanisms and most of the data processing service integration but without dependencies to implementation code (`NoDeps`). This must be done on a fresh checkout as interface artifacts are not deployed via Maven Central/Snapshots.
- `mvn -P App install -DskipTests` compiles the actual application code based on the interfaces generated by `NoDeps`. Installs the application code into the local Maven repository for integration to a full app in the next step. `-DskipTests` may be needed if the Maven test plugin does not work correctly for you as it is the case for many Windows installations we know about.
- `mvn -P EasyGen exec:java@generateApps` does roughly the same as `generateAppsNoDeps` but now utilizes all known service artifact dependencies, in particular those to code compiled and deployed in the previous step. Compiles and packages the full application.

The project contains an identity store (`src/main/resources/identityStore.yml`) declaring all username/password combinations as identity tokes. This includes now the authentication token for the broker. For packaging reasons, the same file must also be located in (`resources/software`). The build process overwrites that file by `src/main/resources/identityStore.yml`, so please make changes only in `src/main/resources/identityStore.yml`. 

Due to licensing issues, the project contains the oktoflow fake version of RTSA. If you want to include that, copy the `resources folder` to `resources.ipr`, add your licensed RTSA/deployment there and call the build commands with `-Diip.resources=resources=%cd%\resources.ipr` on Windows or `-Diip.resources=resources=$PWD/resources.ipr`.

## Model modes and regression tests

The model is set to `flowTest`, i.e., the application is generated for (regression) testing with mocking services. For the real application used in the demonstration, change `flowTest` to false. Depending on the test, test data is be in `src/test/resources`. Please start the broker before.

- OPC UA input: `mvn -P App exec:java@plc-opc`
- MDZH server `mvn -P App exec:java@mdzh-server``
- Cam image source: `mvn -P App exec:java@CamImageSourceTest`
- KiFamilyExampleTest: `mvn -P App exec:java@KiFamilyExampleTest`
- Action decider: `mvn -P App exec:java@ActionDeciderTest` may require `-Diip.app.hm22.mock.callRobot=false`
- AppAasTest: `mvn -P App exec:java@AppAasTest`
- Full application standalone: `mvn -P App exec:java@app -Diip.app.hm22.mock.callRobot=false` does a single run-through with simulated OPC data. Requires MDZH server and broker to be started before separately.

## Command line switches

This app has several command line switches (`mock` indicate mocking/testing parts). You can apply them togeher with `mvn -P App exec:java...` by adding e.g., `-Diip.app.hm22.mock.doEvents=false`.
- `iip.app.hm22.mock.doEvents` (default: `true`) pass the events through to the App AAS
- `iip.app.hm22.mock.logAll` (default: `false`)  log all incoming events/traces. That might be a bit much, just for debugging, in particular the connectors.
- `iip.app.hm22.mock.cmdPeriod` (default: `60000`) period between sending automated/mocked commands
- `iip.app.hm22.usePlc` (default: `false`) use the PLC or the PC Python commands to control the robot
- `iip.app.hm22.env` (default: `HM22`) string to be passed on to the Python robot commands to select the waypoint set
- `iip.app.hm22.camSource.timer` (default: `false`) use a timer integrated into the Cam source to create regular images for testing, one image all 40s
- `iip.app.hm22.mock.callRobot` (default: `false`) allow to call the robot/PLC


## Desirable

- Explaining slides, may be a video.
- Generated service tests