import iip.Registry
from Version import Version
from Service import ServiceState
from Service import ServiceKind
from datatypes.LenzeDriveMeasurement import LenzeDriveMeasurement
from datatypes.LenzeDriveMeasurementImpl import LenzeDriveMeasurementImpl
from datatypes.AggregatedPlcEnergyMeasurement import AggregatedPlcEnergyMeasurement
from datatypes.AggregatedPlcEnergyMeasurementImpl import AggregatedPlcEnergyMeasurementImpl
from datatypes.DriveAiResult import DriveAiResult
from datatypes.DriveAiResultImpl import DriveAiResultImpl
from interfaces.DrivePathPythonbasedAIByLenzeInterface import DrivePathPythonbasedAIByLenzeInterface
import traceback
import sys

##########################################################################################

##########################################################################################

class DrivePathPythonbasedAIByLenze(DrivePathPythonbasedAIByLenzeInterface):
    """Template service implementation for DrivepathPythonbasedAIbyLenze
       Generated by: EASy-Producer."""
       
    lenzeLogic = None
    lastEnergy = None
    
    def __init__(self):
        """Initializes the service.""" 
        super().__init__()
    
    
    def processLenzeDriveMeasurement(self, data: LenzeDriveMeasurement):
        """Asynchronous data processing method. Use self.ingest(data) to pass the result back to the data stream.
    
        Parameters:
          - data -- the data to process
        """
        print("Lenze AI Integration")
        print(data.PROCESS)
        result = DriveAiResultImpl()
        if self.lenzeLogic != None:
            print("running Actual code")
            result = self.lenzeLogic.predictLenzeDriveData(data, self.getAiId())
        else:
            result.error = ['Tension_is_good', 'Tension_to_low', 'Tension_to_high']
            result.energy = self.lastEnergy
            result.setAiId(self.getAiId())
            result.setErrorConfidence([0, 0, 0])

        result.drive = data
        if self.lastEnergy is None:
            en = AggregatedPlcEnergyMeasurementImpl()
            en.channels = []
            result.energy = en
        else:
            result.energy = self.lastEnergy

        self.ingest(result)
        
    def processAggregatedPlcEnergyMeasurement(self, data: AggregatedPlcEnergyMeasurement):
        """Asynchronous data processing method. Use self.ingest(data) to pass the result back to the data stream.
    
        Parameters:
          - data -- the data to process
        """
        if self.lenzeLogic != None:
            self.lenzeLogic.lastEnergy = data
        self.lastEnergy = data
    
    def start(self):
        """Called when the server shall start.
        """
        try:
            from services.LenzeLogic import LenzeLogic
            self.lenzeLogic = LenzeLogic()
        except:
            print(sys.path)
            traceback.print_exc()
        print("Starting")
        pass


#registers itself
DrivePathPythonbasedAIByLenze()
