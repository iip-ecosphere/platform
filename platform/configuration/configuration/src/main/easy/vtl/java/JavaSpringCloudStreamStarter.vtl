import JavaBasics;

@advice(IIPEcosphere)
@indent(indentation = 4, additional = 0)
template JavaSpringCloudStreamStarter(Configuration config, FileArtifact target, String pkg, setOf(String) serializers) {

    def generateSerializerRegistration(setOf(String) serializers) {
        for (String cls : serializers.toSequence()->sortedBy(c|c)) { // sortedBy for testing
            'SerializerRegistry.registerSerializer(${cls}.class);'
        }
    }

    def main(Configuration config, FileArtifact target, String pkg, setOf(String) serializers) {
        'package ${pkg};
        
        import java.util.*;
        import de.iip_ecosphere.platform.services.environment.Service;
        import de.iip_ecosphere.platform.services.environment.YamlArtifact;
        import de.iip_ecosphere.platform.transport.serialization.*;
        import de.iip_ecosphere.platform.transport.spring.SerializerMessageConverter;
        import org.springframework.core.env.Environment;
        import org.springframework.beans.factory.annotation.Autowired;
        import org.springframework.messaging.converter.MessageConverter;
        import org.springframework.boot.autoconfigure.SpringBootApplication;
        import org.springframework.context.annotation.ComponentScan;
        import org.springframework.context.annotation.Bean;
        
        /**
         * Service artifact starter.
         * Generated by: EASy-Producer.
         */
        @SpringBootApplication
        @ComponentScan({"iip.nodes", "de.iip_ecosphere.platform.services.environment.spring", "de.iip_ecosphere.platform.transport.spring"})
        public class Starter extends de.iip_ecosphere.platform.services.environment.spring.Starter {

            /**
            * Creates an instance.
            * 
            * @param environment the Spring environment
            */
            @Autowired
            public Starter(Environment environment) {
                super(environment);
            }
            
            @Override
            protected List<Service> createServices(YamlArtifact artifact) {
                return null; // services do register themselves
            }
            
            /**
            * Creates a custom message converter and binds it against "application/iip".
            * 
            * @return the custom message converter
            */
            @Bean
            public MessageConverter customMessageConverter() {
                return new SerializerMessageConverter();
            }

            /**
             * Starts the service chain.
             *
             * @param args command line arguments
             */        
            public static void main(String[] args) {
                ${generateSerializerRegistration(serializers)}
                main(iip.Starter.class, args);
            }
        
        }
        '
    }
    
}
